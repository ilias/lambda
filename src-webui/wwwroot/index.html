<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lambda Calculus Interpreter UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0d1117; --panel:#161b22; --border:#30363d; --accent:#58a6ff; --text:#c9d1d9; --bad:#ff6b6b; --good:#3fb950; }
    body { font-family: system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--text); margin:0; }
    header { padding:1rem 1.5rem; background:var(--panel); border-bottom:1px solid var(--border); }
    main { max-width:1200px; margin:0 auto; padding:1.25rem; display:grid; gap:1rem; grid-template-columns: 1fr 1fr; }
    section { background:var(--panel); border:1px solid var(--border); border-radius:8px; padding:1rem 1.25rem; display:flex; flex-direction:column; }
    h1 { margin:0; font-size:1.25rem; }
    textarea, input[type=text] { background:#0f141a; color:var(--text); border:1px solid var(--border); border-radius:6px; padding:.6rem .7rem; font-family:ui-monospace,Consolas,monospace; font-size:.95rem; resize:vertical; }
    textarea:focus, input:focus { outline:1px solid var(--accent); }
    button { cursor:pointer; border:1px solid var(--accent); background:var(--accent); color:#fff; border-radius:6px; padding:.55rem .9rem; font-size:.9rem; font-weight:600; display:inline-flex; gap:.4rem; align-items:center; }
    button.secondary { background:transparent; color:var(--accent); }
    button:disabled { opacity:.5; cursor:default; }
    pre { background:#0f141a; border:1px solid var(--border); border-radius:6px; padding:.75rem; overflow:auto; font-size:.85rem; line-height:1.3; }
    code { font-family:ui-monospace,Consolas,monospace; }
    footer { text-align:center; padding:1rem; font-size:.75rem; opacity:.7; }
    .actions { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem; }
    label { font-size:.75rem; font-weight:600; text-transform:uppercase; letter-spacing:.06em; margin-bottom:.25rem; opacity:.85; }
    .small { font-size:.7rem; opacity:.7; }
    .split { display:flex; gap:.75rem; }
    .status { font-size:.75rem; letter-spacing:.05em; text-transform:uppercase; font-weight:600; }
    .bad { color:var(--bad); }
    .good { color:var(--good); }
    @media (max-width: 960px) { main { grid-template-columns:1fr; } }
    /* Log color classes */
    .log-error{color:#ff6b6b;}
    .log-comment{color:#e3b341;}
    .log-result{color:var(--good);}
    .log-step{color:#e3b341;}
    .log-time{color:#58a6ff;}
    .log-name{color:#58a6ff;}
    .log-eval{color:#d2a8ff;}
    .log-macro{color:#58a6ff;}
    .log-test{color:#d2a8ff;}
    .log-test-pass{color:var(--good);}
    .log-test-fail{color:#ff6b6b;}
    .log-command{color:#ff7b72;}
    .log-loading{color:#76e3ea;}
    .log-fileline{color:#8b949e;}
    .log-fileresult{color:var(--good);}
    .log-progress{color:#58a6ff; opacity:.7;}
  </style>
</head>
<body>
  <header><h1>Lambda Calculus Interpreter</h1></header>
  <main>
    <section id="repl">
      <label for="expr">Expression / Commands</label>
      <textarea id="expr" rows="8" placeholder=":help or succ 41 or let add = x,y -> x + y in add 2 3"></textarea>
      <div class="actions">
        <button id="runBtn">Evaluate (Ctrl+Enter)</button>
        <button class="secondary" id="clearBtn" type="button">Clear Output</button>
        <button class="secondary" id="loadStdBtn" type="button">Reload stdlib</button>
        <button class="secondary" id="streamToggle" type="button" data-on="0">Streaming: Off</button>
        <button class="secondary" id="wsToggle" type="button" data-on="0">WS: Off</button>
      </div>
      <div class="small">Multiple expressions separated by semicolons are processed sequentially.</div>
      <label style="margin-top:1rem;" for="output">Result / Log</label>
      <pre id="output" aria-live="polite"></pre>
    </section>
    <section>
      <label for="filePath">Load .lambda File</label>
      <div class="split">
        <input type="text" id="filePath" placeholder="path e.g. stdlib.lambda" />
        <button id="loadBtn" type="button">Load</button>
      </div>
      <div id="fileStatus" class="status" style="margin-top:.5rem;">Idle</div>
      <div id="fileProgress" style="margin-top:.4rem;height:6px;background:#222;border:1px solid var(--border);border-radius:4px;overflow:hidden;display:none;">
        <div id="fileProgressBar" style="height:100%;width:0;background:var(--accent);transition:width .25s;"></div>
      </div>
      <hr style="margin:1rem 0; border:0; border-top:1px solid var(--border);" />
      <h3 style="margin-top:0;">Quick Examples</h3>
      <ul style="margin:.25rem 0 0 1.1rem; padding:0; font-size:.8rem; line-height:1.4;">
        <li>succ 5</li><li>let inc = x -> succ x in inc 41</li><li>[1,2,3]</li><li>let rec fact = n -> if (iszero n) 1 (mult n (fact (pred n))) in fact 5</li>
      </ul>
    </section>
  </main>
  <footer>Lambda Calculus Interpreter UI â€¢ <span id="health">checking...</span></footer>
  <script>
    // ---- API helpers ----
    async function evalExpr(expr){
      const r = await fetch(`/api/eval?expr=${encodeURIComponent(expr)}`);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }
    async function loadFile(p){
      const r = await fetch('/api/load',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:p})});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    // ---- Elements ----
    const exprEl = document.getElementById('expr');
    const outEl = document.getElementById('output');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const loadStdBtn = document.getElementById('loadStdBtn');
    const streamToggle = document.getElementById('streamToggle');
    const wsToggle = document.getElementById('wsToggle');
    const loadBtn = document.getElementById('loadBtn');
    const filePathEl = document.getElementById('filePath');
    const fileStatus = document.getElementById('fileStatus');
    const fileProgress = document.getElementById('fileProgress');
    const fileProgressBar = document.getElementById('fileProgressBar');

    // ---- Log classification & append (with cap) ----
    const MAX_LOG_LINES = 2000;
    function classify(line){
      if(line.startsWith('PROGRESS::')) return 'log-progress';
      if(line.startsWith('Error:')) return 'log-error';
      if(line.startsWith('#')) return 'log-comment';
      if(line.startsWith('->')) return 'log-result';
      if(line.startsWith('Step')) return 'log-step';
      if(line.startsWith('Time:')) return 'log-time';
      if(line.startsWith('Name:')) return 'log-name';
      if(line.startsWith('Eval:')) return 'log-eval';
      if(line.startsWith('Macro')) return 'log-macro';
      if(line.startsWith('Test: passed')) return 'log-test-pass';
      if(line.startsWith('Test: failed')) return 'log-test-fail';
      if(line.startsWith('Test:')) return 'log-test';
      if(line.startsWith(':')) return 'log-command';
      if(line.includes('Loading')) return 'log-loading';
      if(line.includes('<<')) return 'log-fileline';
      if(line.includes('>>')) return 'log-fileresult';
      return '';
    }
    function append(text){
      const cls = classify(text);
      const span = document.createElement('span');
      if(cls) span.className = cls;
      span.textContent = text;
      outEl.appendChild(span);
      outEl.appendChild(document.createTextNode('\n'));
      // Trim (span + newline nodes considered)
      const maxNodes = MAX_LOG_LINES * 2;
      if(outEl.childNodes.length > maxNodes){
        while(outEl.childNodes.length > maxNodes){ outEl.removeChild(outEl.firstChild); }
      }
      outEl.scrollTop = outEl.scrollHeight;
    }

    // ---- Streaming (SSE / WebSocket) ----
    let es=null, ws=null; let streaming=false, useWS=false;
    function handleProgress(pct){
      fileProgress.style.display='block';
      fileProgressBar.style.width=pct+'%';
      if(pct>=100) setTimeout(()=>{ fileProgress.style.display='none'; fileProgressBar.style.width='0%'; },1200);
    }
    function ensureStream(){
      if(!streaming) return;
      if(useWS){
        if(ws && ws.readyState===WebSocket.OPEN) return;
        if(ws) { try{ ws.close(); }catch{} ws=null; }
        ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws');
        ws.onmessage = ev => {
          const d = ev.data;
            if(typeof d==='string'){
              if(d.startsWith('PROGRESS::')) handleProgress(parseInt(d.split('::')[1]||'0',10)); else append(d);
            }
        };
        ws.onclose = ()=>{ if(streaming && useWS) setTimeout(ensureStream, 1200); };
        ws.onerror = ()=>{ try{ ws.close(); }catch{} if(streaming && useWS) setTimeout(ensureStream,1200); };
      } else {
        if(es) return;
        es = new EventSource('/api/stream');
        es.onmessage = e => {
          if(e.data && e.data!=='.'){
            if(e.data.startsWith('PROGRESS::')) handleProgress(parseInt(e.data.split('::')[1]||'0',10)); else append(e.data);
          }
        };
        es.onerror = ()=>{ es.close(); es=null; if(streaming && !useWS) setTimeout(ensureStream,1500); };
      }
    }
    streamToggle.addEventListener('click',()=>{
      streaming = !streaming;
      streamToggle.dataset.on = streaming ? '1':'0';
      streamToggle.textContent = 'Streaming: ' + (streaming?'On':'Off');
      if(streaming){ ensureStream(); append('[streaming enabled via '+(useWS?'WebSocket':'SSE')+']'); }
      else { if(es){ es.close(); es=null; } if(ws){ ws.close(); ws=null; } append('[streaming disabled]'); }
    });
    wsToggle.addEventListener('click',()=>{
      useWS = !useWS;
      wsToggle.dataset.on = useWS ? '1':'0';
      wsToggle.textContent = 'WS: ' + (useWS?'On':'Off');
      if(streaming){ if(es){ es.close(); es=null; } if(ws){ try{ ws.close(); }catch{} ws=null; } ensureStream(); append('[switched to '+(useWS?'WebSocket':'SSE')+']'); }
    });

    // ---- Evaluation ----
    async function doEval(){
      const raw = exprEl.value.trim();
      if(!raw) return;
      runBtn.disabled = true;
      try {
        const res = await evalExpr(raw);
        append(`> ${raw}`);
        if(!streaming){
          if(Array.isArray(res.logs) && res.logs.length) res.logs.forEach(l=>append(l));
          const primary = res.output || res.normalized || '(no output)';
          if(!res.logs || !res.logs.includes(primary)) append(primary);
          if(res.normalized && res.normalized !== primary && (!res.logs || !res.logs.includes(res.normalized))) append(res.normalized);
        } else {
          // streaming: only final outputs (logs already streamed)
          const primary = res.output || res.normalized || '(no output)';
          append(primary);
          if(res.normalized && res.normalized !== primary) append(res.normalized);
        }
        append('');
      } catch(e){ append(`ERR: ${e.message}`); }
      finally { runBtn.disabled=false; }
    }

    runBtn.addEventListener('click', doEval);
    exprEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); doEval(); }});
    clearBtn.addEventListener('click', ()=>{ outEl.textContent=''; });
    loadStdBtn.addEventListener('click', ()=>{ filePathEl.value='stdlib.lambda'; loadBtn.click(); });
    loadBtn.addEventListener('click', async ()=>{
      const p = filePathEl.value.trim(); if(!p) return;
      fileStatus.textContent='Loading...';
      if(streaming){ fileProgress.style.display='block'; fileProgressBar.style.width='0%'; }
      try {
        const r = await loadFile(p);
        fileStatus.textContent = 'Loaded: ' + r.message;
        if(!streaming && r.logs && Array.isArray(r.logs) && r.logs.length){ r.logs.forEach(l=>append(l)); append(''); }
      } catch(e){ fileStatus.textContent = 'Error: ' + e.message; }
    });

    // ---- Health + auto-init ----
    fetch('/api/health').then(r=>r.ok?document.getElementById('health').textContent='ready':null).catch(()=>{});
    if(location.hash.includes('stream')) streamToggle.click();
  </script>
</body>
</html>
